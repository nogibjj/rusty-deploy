## A Distroless Rust PyTorch Example

To run: 

```
dbuild:
	docker build -t pytorch-rust-distroless .

drun:
	docker run -p 8080:8080 pytorch-rust-distroless
```

## Disclaimer!

This is built for POC (Proof of concept) and doesn't handle edge cases in any manner, you must extend.

### Rust Image Prediction Web Server

This is a Rust code that uses the Actix Web framework to create a simple web server that takes an image as input, runs it through a pre-trained ResNet34 model to make a prediction, and returns the predicted class and confidence score as a JSON response.


## Route: `/`

This is the root route that provides instructions on how to send an image payload to the server using curl. The payload must be sent as a `multipart/form-data` and the image file must be attached using the `-F` option in the curl command.

**Method:** `GET`

**Response:**

A `200 OK` response with a message containing instructions on how to send an image payload using curl.

## Route: `/predict`

This route is used to predict the content of an image. The image must be sent as a `multipart/form-data` payload and must be saved to a temporary directory before being passed to the prediction function. The predicted content of the image is returned in the response.

**Method:** `POST`

**Request Payload:**

A `multipart/form-data` payload containing an image file.

**Response:**

- If the prediction is successful, a `200 OK` response with a JSON object containing a `"status"` field with a value of `"success"` and a `"result"` field with the predicted content of the image.
- If the prediction fails, a `500 Internal Server Error` response with a JSON object containing a `"status"` field with a value of `"error"` and a `"message"` field with the error message.

## Route: `/check_image_upload`

This route is used to check if an image upload was successful. The image must be sent as a `multipart/form-data` payload and must be saved to a temporary directory before being passed to the check function. The response contains a JSON object with the status of the upload and the filepath of the saved image.

**Method:** `POST`

**Request Payload:**

A `multipart/form-data` payload containing an image file.

**Response:**

A `200 OK` response with a JSON object containing either a `"status"` field with a value of `"success"` and a `"filepath"` field with the path of the saved image or a `"status"` field with a value of `"error"` and an `"error"` field with the error message.

## Route: `/check_pytorch_cpu`

This route is used to check if PyTorch is running on the CPU. The response contains a message indicating whether the self-check was successful or not.

**Method:** `GET`

**Response:**

A `200 OK` response with a message indicating whether the self-check was successful or not.

## Route: `/check_image_prediction`

This route is used to check if the image recognition model is working correctly. The response contains the result of a self-check performed on the image recognition model.

**Method:** `GET`

**Response:**

- If the self-check is successful, a `200 OK` response with a JSON object containing a `"status"` field with a value of `"success"` and a `"result"` field with the self-check result.
- If the self-check fails, a `500 Internal Server Error` response with a JSON object containing a `"status"` field with a value of `"error"` and a `"message"` field with the error message.


## Main Function

The `main` function sets up the logger, initializes the Actix Web server, and binds it to the "127.0.0.1:8080" address.

## Debugging

`RUST_BACKTRACE=1 cargo run`

### Install

* run `./install.sh` to setup torchlib
* You should see a successful test like follows:

```bash
/usr/local/lib/libtorch already exists. Deleting it to proceed with the installation.
LIBTORCH is already in ~/.bashrc
LD_LIBRARY_PATH is already in ~/.bashrc
Checking if libtorch is installed correctly...
Verifying that C++ PyTorch API is functional...
-- Configuring done
-- Generating done
-- Build files have been written to: /workspaces/rusty-deploy/rtorchdist/build
Scanning dependencies of target check_pytorch
[ 50%] Building CXX object CMakeFiles/check_pytorch.dir/check_pytorch.cpp.o
[100%] Linking CXX executable check_pytorch
[100%] Built target check_pytorch
 0.2312  0.1560  0.2892
 0.1933  0.5848  0.6959
[ CPUFloatType{2,3} ]
C++ PyTorch API is functional. Installation complete.

```

### Test against Image

* The index route will give you an example to curl against.
* Selfcheck routes will self check functions

### More Testing

* You can run: `cargo test --test vision_tests` after you build to ensure PyTorch is actually working with Rust bindings
* You can run: `cargo test --test model_tests` which tests model loading or `cargo test --test model_tests -- --nocapture`


#### Notes

* Pre-trained model here generated by running inside a python virtualenv:  `./convertdl.py`
* Next verify the model works by running in virtualenv: `./verify.py`
* You can download checksummed models by running: ./sync-models.sh
